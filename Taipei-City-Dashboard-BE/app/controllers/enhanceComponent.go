package controllers

import (
	"TaipeiCityDashboardBE/app/models"
	"TaipeiCityDashboardBE/app/util"
	"encoding/json"
	"fmt"
	"github.com/gin-gonic/gin"
	"github.com/lib/pq"
	"io/ioutil"
	"math/rand"
	"net/http"
	"strconv"
	"strings"
)

type TagScore struct {
	TagName string  `json:"tag_name"`
	Score   float64 `json:"score"`
}

type RequestTagScores struct {
	Question string `json:"question" form:"question"`
}

type ResponseTagScores struct {
	Question  string     `json:"question" form:"question"`
	Scores    []TagScore `json:"scores"`
	Threshold int        `json:"threshold"`
}

type RequestUpdateDashboardComponents struct {
	Tags           []string `json:"tags" form:"tags"`
	DashboardIndex string   `json:"dashboard_index" form:"dashboard_index"`
}

/*
{
    "code": 200,
    "data": [
        {
            "distance": 14.953648,
            "id": "449613054009456703",
            "info": "公車",
            "theme": "[綠運]電動巴士淨零貢獻量"
        },
*/

type VertorQueryResponse struct {
	Code int `json:"code"`
	Data []struct {
		Distance float64 `json:"distance"`
		ID       string  `json:"id"`
		Info     string  `json:"info"`
		Theme    string  `json:"theme"`
	}
}

func FetchVertorDB(payload *strings.Reader) VertorQueryResponse {
	url := "http://10.8.0.4:19530/v1/vector/search"
	method := "POST"

	client := &http.Client{}
	req, err := http.NewRequest(method, url, payload)

	if err != nil {
		fmt.Println(err)
		return VertorQueryResponse{}
	}
	req.Header.Add("Content-Type", "application/json")

	res, err := client.Do(req)
	if err != nil {
		fmt.Println(err)
		return VertorQueryResponse{}
	}
	defer res.Body.Close()

	body, err := ioutil.ReadAll(res.Body)
	if err != nil {
		fmt.Println(err)
		return VertorQueryResponse{}
	}
	var response VertorQueryResponse
	err = json.Unmarshal(body, &response)
	if err != nil {
		fmt.Println(err)
		return VertorQueryResponse{}
	}

	return response
}

func SetDashboardComponents(c *gin.Context) {
	// Get all query parameters from context
	var query RequestUpdateDashboardComponents
	if err := c.BindQuery(&query); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"status": "error", "message": err.Error()})
		return
	}

	query.DashboardIndex = "cd4d75a76ce7"

	sql := "SELECT * FROM components WHERE "
	for i, tag := range query.Tags {
		if i == 0 {
			sql += "tags LIKE '%" + tag + "%' "
		} else {
			sql += "OR tags LIKE '%" + tag + "%' "
		}
	}

	// get components
	components := []models.Component{}
	err := models.DBManager.Raw(sql).Scan(&components).Error
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"status": "error", "message": err.Error()})
		return
	}

	// find dashboard
	dashboard := models.Dashboard{}
	err = models.DBManager.Where("index = ?", query.DashboardIndex).First(&dashboard).Error
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"status": "error", "message": err.Error()})
		return
	}

	componentsIDs := pq.Int64Array{}
	for _, component := range components {
		componentsIDs = append(componentsIDs, component.ID)
	}

	// get dashboard_groups by dashboard id
	dashboardGroups := []models.DashboardGroup{}
	err = models.DBManager.Where("dashboard_id = ?", dashboard.ID).Find(&dashboardGroups).Error
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"status": "error", "message": err.Error()})
		return
	}

	var groups []int
	for _, dashboardGroup := range dashboardGroups {
		groups = append(groups, dashboardGroup.GroupID)
	}

	newDashboard, err := models.UpdateDashboard(dashboard.Index, dashboard.Name, dashboard.Icon, componentsIDs, groups)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"status": "error", "message": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"status": "success", "data": newDashboard})
}

func GetTagScores(c *gin.Context) {
	question := RequestTagScores{}
	if err := c.BindQuery(&question); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"status": "error", "message": err.Error()})
		return
	}
	/*
		主題,TAG1,TAG2,TAG3,TAG4,TAG5,TAG6,TAG7,TAG8,TAG9,TAG10
		人均減碳,碳排放,能源消耗,環保政策,節能減碳,溫室氣體,氣候變遷,環境永續,二氧化碳當量,減碳管理,能源效率
		刑事統計,犯罪率,治安維護,罪案類型,地區熱點,破案率,警力資源,預防犯罪,社區安全,資料分析,政策規劃
		台北市各區即時空氣品質,空氣污染,PM2.5濃度,環境監測,健康風險,污染來源,敏感區域,揚塵管控,空品預警,民生品質,永續城市
		抽水站狀態,防災應變,水利設施,抽水站運作,水位監控,排水系統,防汛整備,易淹水區域,雨災風險,基礎建設,緊急應變
		社福人口,低收入戶,身心障礙,弱勢關懷,社會資源,生活補助,福利政策,人口統計,經濟狀況,社會公平,風險評估
		社福機構,社會服務,機構分布,弱勢族群,服務資源,社區照顧,長期照護,兒少保護,婦女權益,專業輔導,民間組織
		綠電發電量,再生能源,發電量,能源結構,環境保護,碳中和,能源轉型,綠能政策,發電效率,減碳目標,科技創新
		資源站可回收項目,資源回收,廢棄物處理,環保意識,循環經濟,垃圾分類,資源再利用,減廢政策,回收率,環境教育,永續發展
		閒置市有財產,公有地,閒置資產,資產管理,土地利用,都市規劃,地政,土地徵收,興辦事業,場所再利用,市地重劃
	*/
	/*
		tags := []string{
			"人均減碳", "碳排放", "能源消耗", "環保政策", "節能減碳", "溫室氣體", "氣候變遷", "環境永續", "二氧化碳當量", "減碳管理", "能源效率",
			"刑事統計", "犯罪率", "治安維護", "罪案類型", "地區熱點", "破案率", "警力資源", "預防犯罪", "社區安全", "資料分析", "政策規劃",
			"台北市各區即時空氣品質", "空氣污染", "PM2.5濃度", "環境監測", "健康風險", "污染來源", "敏感區域", "揚塵管控", "空品預警", "民生品質", "永續城市",
			"抽水站狀態", "防災應變", "水利設施", "抽水站運作", "水位監控", "排水系統", "防汛整備", "易淹水區域", "雨災風險", "基礎建設", "緊急應變",
			"社福人口", "低收入戶", "身心障礙", "弱勢關懷", "社會資源", "生活補助", "福利政策", "人口統計", "經濟狀況", "社會公平", "風險評估",
			"社福機構", "社會服務", "機構分布", "弱勢族群", "服務資源", "社區照顧", "長期照護", "兒少保護", "婦女權益", "專業輔導", "民間組織",
			"綠電發電量", "再生能源", "發電量", "能源結構", "環境保護", "碳中和", "能源轉型", "綠能政策", "發電效率", "減碳目標", "科技創新",
			"資源站可回收項目", "資源回收", "廢棄物處理", "環保意識", "循環經濟", "垃圾分類", "資源再利用", "減廢政策", "回收率", "環境教育", "永續發展",
			"閒置市有財產", "公有地", "閒置資產", "資產管理", "土地利用", "都市規劃", "地政", "土地徵收", "興辦事業", "場所再利用", "市地重劃",
		}
	*/
	//tags := []string{
	//	"[創綠]綠電發電用電佔比量", "再生能源", "發電量", "能源結構", "環境保護", "碳中和", "能源轉型", "綠能政策", "發電效率", "減碳目標", "數據分析", "用電", "創綠",
	//	"[永續]台北市各區即時空氣品質", "空氣污染", "PM2.5濃度", "環境監測", "健康風險", "污染來源", "敏感區域", "揚塵管控", "空品預警", "區域差異", "數據視覺化", "空氣品質", "永續",
	//	"[永續]台北市各區歷年空氣品質", "空氣污染", "PM2.5濃度", "環境監測", "健康風險", "污染來源", "敏感區域", "揚塵管控", "空品預警", "區域差異", "數據趨勢", "空氣品質", "永續",
	//	"[減廢]循環杯租借分佈", "環保意識", "減廢政策", "資源再利用", "永續發展", "循環經濟", "社區參與", "公共設施", "地理分佈", "市政建設", "綠色生活", "環保餐具", "減廢",
	//	"[減廢]資源站可回收項目", "資源回收", "廢棄物處理", "環保意識", "循環經濟", "垃圾分類", "資源再利用", "減廢政策", "回收率", "環境教育", "永續發展", "環保餐具", "減廢",
	//	"[節電]輔導節電統計", "節能減碳", "能源效率", "用電行為", "節電措施", "用電數據", "家戶用電", "補助政策", "目標管理", "統計分析", "政策評估", "節能減碳", "節能",
	//	"[綠運]電動巴士淨零貢獻量", "淨零", "電動公車", "綠色交通", "電動車輛", "可再生能源", "空氣污染", "溫室氣體", "能源轉型", "環境保護", "永續發展", "氣候行動", "創新技術", "公車", "市政府", "節能減碳",
	//	"[除碳]人均減碳", "碳排放", "能源消耗", "環保政策", "節能減碳", "溫室氣體", "氣候變遷", "環境永續", "二氧化碳當量", "減碳管理", "數據分析", "節能減碳", "除碳",
	//	"[除碳]台北市歷年排碳與人口數", "台北市", "碳排放", "人口變化", "氣候影響", "能源使用", "城市規劃", "減排政策", "碳足跡", "環境數據", "數據分析", "長期趨勢", "節能減碳",
	//}

	// random score for each tag, use random number for now
	var tagScores []TagScore
	//for _, tag := range tags {
	//	score := rand.Intn(20)
	//	// spec list
	//	if strings.Contains(question.Question, "公車") {
	//
	//	}
	//	tagScores = append(tagScores, TagScore{TagName: tag, Score: score})
	//}

	payloadBus := strings.NewReader(`
{
    "collectionName": "TAG",
      "limit": 108,
    "vector":[0.0881979838013649, 0.1544143110513687, 0.1706557422876358, -0.049101900309324265, 0.04420899599790573, -0.027525827288627625, 0.01900324411690235, -0.1734674870967865, -0.20032255351543427, 0.08428911119699478, -0.09176932275295258, 0.1275758445262909, 0.2790455222129822, 0.16398462653160095, -0.06262227147817612, 0.2157820761203766, -0.11251692473888397, 0.20057892799377441, -0.053189266473054886, 0.014410719275474548, -0.1629386693239212, 0.2217715084552765, -0.03045627474784851, -0.10256272554397583, 0.16751030087471008, -0.14617906510829926, 0.18732544779777527, 0.027923721820116043, 0.29003140330314636, -0.045912258327007294, -0.016724878922104836, 0.11763171851634979, 0.12549076974391937, 0.02242356538772583, 0.14426939189434052, 0.1246584877371788, 0.013790923170745373, 0.18411660194396973, 0.11628539860248566, 0.02758132852613926, -0.15217190980911255, 0.18929073214530945, 0.125697061419487, 0.045268911868333817, -0.09064360707998276, 0.2783823609352112, -0.022243063896894455, -0.019325394183397293, -0.018403349444270134, -0.2117449790239334, 0.03521803021430969, 0.12009594589471817, 0.0315215066075325, -0.04408206418156624, -0.056450970470905304, -0.1398778259754181, 0.11303456872701645, -0.09577770531177521, 0.09925784915685654, -0.21575483679771423, -0.05619592219591141, -0.0862857773900032, 0.015161861665546894, -0.08266276866197586, 0.0902695581316948, -0.004609344061464071, 0.0340583398938179, -0.38152873516082764, -0.009026946499943733, 0.025455480441451073, 0.08336067199707031, -0.15458199381828308, -0.09285189211368561, 0.11662819236516953, -0.28320565819740295, -0.04949123039841652, -0.20813696086406708, 0.06419918686151505, 0.21486711502075195, 0.052558861672878265, -0.01645464263856411, 0.05790676921606064, -0.09719470888376236, 0.22863490879535675, -0.11287965625524521, 0.10942759364843369, 0.09758219122886658, 0.05484003573656082, 0.10281118005514145, -0.050773002207279205, 0.03866594284772873, -0.06208232790231705, -0.14667131006717682, -0.11545850336551666, -0.12093140929937363, -0.06677646934986115, 0.04352086782455444, -0.17503705620765686, -0.07080544531345367, 0.00593176344409585, 0.16058656573295593, -0.06606695055961609, 0.3142552077770233, -0.06414532661437988, -0.13975033164024353, 0.02218690514564514, -0.28897202014923096, -0.11909230053424835, 0.08814490586519241, 0.052812300622463226, 0.18574020266532898, -0.11825747787952423, 0.05305538326501846, 0.15383313596248627, 0.004489933140575886, 0.06401290744543076, 0.09726278483867645, 0.29609572887420654, -0.17182280123233795, 0.17802785336971283, -0.2028309851884842, -0.10911597311496735, 0.14897184073925018, -0.013576487079262733, -0.10613636672496796, 0.18976524472236633, -0.12362904846668243, -0.1040160208940506, 0.0806339904665947, -0.04301343485713005, -0.1653040200471878, 0.2918228209018707, 0.07868104428052902, 0.048063453286886215, -0.0364125519990921, 0.09844911843538284, 0.18651553988456726, 0.13179056346416473, -0.15527230501174927, 0.05223500728607178, -0.0007415292784571648, 0.0997176319360733, 0.1167759895324707, -0.04073168709874153, 0.09553520381450653, -0.07192596793174744, -0.19672833383083344, 0.14055678248405457, 0.1843058317899704, 0.04876454547047615, -0.023373553529381752, 0.3798798620700836, 0.08416332304477692, 0.14840319752693176, -0.13126754760742188, -0.18279466032981873, 0.08636263012886047, -0.34193381667137146, 0.014652962796390057, -0.14393047988414764, 0.11303283274173737, -0.21520772576332092, -0.11144834756851196, 0.16129782795906067, -0.05167020112276077, 0.17923888564109802, 0.22336363792419434, 0.19196048378944397, 0.010737688280642033, 0.02378864213824272, -0.02366768941283226, 0.0037464499473571777, -0.0015904279425740242, 0.12551060318946838, -0.09343104064464569, -0.05817336589097977, -0.020392242819070816, 0.04393971338868141, -0.11557392030954361, 0.16468945145606995, 0.10565366595983505, 0.021725023165345192, -0.03765391558408737, 0.06279335916042328, -0.003325793892145157, 0.12892906367778778, -0.2431400716304779, 0.11948087066411972, -0.028544152155518532, -0.056081753224134445, -0.04671279713511467, 0.24865031242370605, 0.043312519788742065, -0.17205247282981873, 0.15510375797748566, -0.09715385735034943, 0.005139125045388937, 0.07958970963954926, -0.0433090478181839, 0.023953311145305634, 0.2558515667915344, 0.06633098423480988, -0.10922642052173615, 0.16223251819610596, 0.09022669494152069, 0.05868446081876755, -0.11393070220947266, 0.09326738864183426, -0.1675179898738861, -0.5144790410995483, -0.15400229394435883, 0.09766769409179688, -0.32428622245788574, 0.12482557445764542, -0.014114650897681713, 0.06244559958577156, -0.15558378398418427, -0.3797362744808197, -0.031251709908246994, -0.17876684665679932, 0.13675697147846222, -0.1532454788684845, 0.1687842309474945, 0.02500304952263832, 0.0729849562048912, 0.1267925202846527, -0.06138000637292862, -0.20927473902702332, 0.09433633089065552, -0.05857525020837784, -0.21062345802783966, -0.0894511416554451, -0.00306869437918067, 0.019685739651322365, 0.19928255677223206, 0.053096968680620193, 0.04285300523042679, -0.19432327151298523, -0.006178886629641056, -0.1829453855752945, -0.20263223350048065, 0.10275517404079437, -0.0025834653060883284, -0.24995729327201843, 0.24079346656799316, -0.01655440218746662, 0.18479697406291962, -0.2210986167192459, -0.15889884531497955, -0.03309779241681099, -0.1333165168762207, -0.07579420506954193, 0.020092200487852097, 0.08319050818681717, -0.21423092484474182, -0.22303864359855652, 0.3057841658592224, 0.05702456086874008, -0.13777437806129456, -0.12046422064304352, 0.06616806983947754, -0.25147557258605957, 0.19915077090263367, -0.033090367913246155, 0.2321842908859253, 0.06848792731761932, -0.11306357383728027, -0.03832720220088959, 0.006225972436368465, -0.21329882740974426, 0.030924424529075623, 0.09155766665935516, 0.05078442767262459, -0.06445057690143585, -0.007463944144546986, -0.07117539644241333, 0.03386637941002846, 0.0029764329083263874, 0.15021678805351257, 0.006083601154386997, 0.17263910174369812, 0.05971803516149521, 0.04492313787341118, -0.13272058963775635, 0.1507556140422821, 0.2053087204694748, 0.17146143317222595, 0.14139389991760254, -0.3434288501739502, 0.006690590176731348, -0.08044502884149551, -0.13566717505455017, 0.19782811403274536, -0.1822792887687683, 0.1381535530090332, -0.06645523011684418, -0.19916269183158875, 0.047333668917417526, -0.11665065586566925, -0.027921566739678383, -0.11007128655910492, 0.08859385550022125, 0.1504356861114502, -0.047223638743162155, 0.19338509440422058, -0.0631302148103714, -0.003609228413552046, 0.0846005529165268, 0.07279603183269501, 0.027341317385435104, 0.2895509600639343, 0.0026064631529152393, 0.03690660744905472, -0.03263690322637558, -0.06739387661218643, 0.05191925913095474, -0.14828191697597504, -0.05158831924200058, -0.0843648910522461, 0.14320576190948486, 0.08008477836847305, -0.08189810812473297, 0.030551981180906296, -0.02542857825756073, -0.0960516482591629, -0.25847798585891724, -0.12287764251232147, 0.17744281888008118, -0.07632707059383392, 0.006450141780078411, 0.21204988658428192, 0.08471693843603134, -0.18477219343185425, 0.08222077041864395, 0.10385666787624359, 0.21082575619220734, 0.20377647876739502, 0.06886132806539536, 0.08732584118843079, -0.0004512023297138512, 0.14779958128929138, 0.14997291564941406, -0.1855328381061554, -0.11729569733142853, 0.11269555240869522, 0.04088003188371658, 0.07564570009708405, -0.098375603556633, 0.13855531811714172, 0.12180458009243011, 0.268842488527298, -0.06565695255994797, 0.29211750626564026, 0.08049207925796509, 0.12414336204528809, -0.11796553432941437, -0.014947089366614819, -0.006000842433422804, 0.04016043618321419, 0.0735003650188446, 0.04008171707391739, 0.039884936064481735, 0.07561811059713364, 0.09652507305145264, 0.004999675787985325, -0.11794871091842651, -0.00580557668581605, 0.02174130640923977, -0.2120658904314041, -0.10958480834960938, 0.21159017086029053, -0.12660519778728485, -0.056460630148649216, 0.007944012060761452, 0.09683772176504135, 0.01460406742990017, -0.0716131404042244, -0.05555300787091255, -0.24984213709831238, 0.007727484218776226, 0.025104444473981857, 0.2993393540382385, 0.2938435971736908, 0.17736339569091797, 0.13359501957893372, -0.31118473410606384, 0.013898888602852821, 0.20120620727539062, 0.19047090411186218, -0.29847508668899536, -0.018523558974266052, 0.06321240961551666, -0.010657456703484058, 0.0674799308180809, 0.08133645355701447, -0.04911263659596443, -0.1251590996980667, -0.11869201809167862, -0.18128392100334167, 0.28270697593688965, 0.06236014515161514, 0.06356818974018097, -0.27390390634536743, 0.0018990561366081238, 0.25167059898376465, -0.024541759863495827, 0.13203482329845428, -0.14544567465782166, 0.12266991287469864, 0.03193267062306404, -0.2316560298204422, 0.14306044578552246, -0.05922190472483635, -0.0874272957444191, -0.09973745048046112, 0.034537870436906815, 0.024705294519662857, -0.08869200199842453, -0.04393235966563225, -0.12499449402093887, 0.005849982611835003, 0.19166460633277893, -0.0490083321928978, -0.09216086566448212, 0.008109299466013908, -0.0034677230287343264, 0.08764312416315079, 0.14716733992099762, -0.21317227184772491, -0.009249448776245117, -0.03446023166179657, 0.14506570994853973, 0.10899661481380463, -0.05784621089696884, 0.12426470220088959, -0.24114727973937988, -0.08208173513412476, -0.29491737484931946, -0.09630080312490463, 0.02064834162592888, -0.0657007098197937, -0.08192625641822815, -0.0593615397810936, -0.07976442575454712, -0.1539008766412735, -0.01832542009651661, 0.14408889412879944, 0.02639106474816799, 0.12135417759418488, 0.12417080253362656, 0.22450193762779236, 0.2512980103492737, -0.11039123684167862, 0.0184684619307518, -0.07487677037715912, -0.042601052671670914, 0.11803622543811798, -0.10317428410053253, -0.058188296854496, -0.05048976466059685, 0.1876356303691864, 0.025929251685738564, -0.23308143019676208, -0.025999512523412704, -0.25038236379623413, -0.025564858689904213, 0.08882848173379898, 0.19928191602230072, 0.1228746771812439, -0.24015657603740692, -0.04116196930408478, 0.058297909796237946, 0.14359216392040253, -0.18702225387096405, -0.19650129973888397, 0.16993771493434906, 0.06043536588549614, 0.2095579355955124, -0.006716776639223099, -0.030153101310133934, 0.11424688994884491, 0.06744759529829025, 0.19017663598060608, -0.17739169299602509, -0.08272109925746918, -0.1825789511203766, -0.16124087572097778, 0.20063714683055878, -0.10015761852264404, -0.06926536560058594, -0.08015109598636627, -0.11180403083562851, 0.03722963482141495, -0.2221187800168991, -0.019375810399651527, 0.010664333589375019, -0.12553346157073975, 0.04354412853717804, -0.0038098343648016453, 0.03648317977786064, 0.11277101188898087, 0.23397588729858398, 0.0035944737028330564, -0.11643318086862564, -0.23514333367347717, -0.11076287180185318, 0.008247233927249908, 0.05878244712948799, -0.1370721161365509, -0.10956595093011856, -0.1959885209798813, -0.06602079421281815, -0.2455701380968094, -0.28878694772720337, -0.04243212193250656, -0.026767486706376076, 0.0043198722414672375, 0.05793484300374985, 0.11609568446874619, -0.011056017130613327, 0.027507588267326355, -0.02997780777513981, 0.15033599734306335, -0.11380445957183838, -0.0033288944978266954, 0.12547175586223602, -0.14096280932426453, -0.2246662825345993, 0.04950403422117233, -0.24390947818756104, 0.15620136260986328, 0.13994362950325012, -0.008670324459671974, 0.21317562460899353, -0.05016452074050903, -0.005272554233670235, -0.1822495013475418, 0.033776335418224335, -0.24461135268211365, -0.11865635216236115, -0.02068636380136013, -0.15861448645591736, 0.15430480241775513, 0.012100541964173317, 0.025108661502599716, -0.07706159353256226, -0.08865789324045181, -0.10856101661920547, -0.10581739246845245, -0.028504973277449608, 0.06555171310901642, 0.21589617431163788, 0.037413954734802246, 0.11370500177145004, -0.06105951592326164, -0.16926643252372742, 0.08382277935743332, -0.028363507241010666, 0.17720580101013184, 0.10311631858348846, 0.20810990035533905, 0.24710078537464142, 0.18452508747577667, 0.08409369736909866, -0.2081512212753296, 0.04478961601853371, 0.11068648099899292, 0.039042722433805466, -0.13348884880542755, -0.3858086168766022, 0.14253100752830505, 0.023220032453536987, 0.31686660647392273, -0.14094682037830353, 0.08389468491077423, 0.09066212177276611, -0.2540735602378845, -0.12680843472480774, 0.11997686326503754, -0.12829086184501648, 0.14045210182666779, 0.08742227405309677, -0.19622501730918884, -0.227667897939682, -0.27741315960884094, 0.07874859869480133, 0.17691990733146667, 0.2004079818725586, -0.055785976350307465, -0.13834340870380402, 0.1342511624097824, -0.10537385940551758, 0.09424358606338501, 0.17408092319965363, 0.09682371467351913, -0.20376095175743103, -0.13171419501304626, 0.08650007098913193, -0.32066258788108826, -0.09538877010345459, 0.059536002576351166, 0.3296002447605133, 0.0015545841306447983, -0.08441377431154251, -0.040443290024995804, 0.1073610931634903, -0.06611166894435883, -0.1002606749534607, 0.11126790195703506, -0.10417650640010834, 0.2843642830848694, -0.12442169338464737, -0.04086115211248398, 0.18189287185668945, 0.15097995102405548, -0.010691575706005096, 0.033344678580760956, 0.059743888676166534, -0.038412921130657196, 0.054765891283750534, -0.07367193698883057, 0.029989242553710938, -0.2263905107975006, 0.15521001815795898, 0.13146120309829712, -0.11816934496164322, -0.0898650735616684, 0.1218656525015831, 0.13529515266418457, -0.04781567305326462, -0.0435725636780262, 0.12314765155315399, 0.18763157725334167, -0.012031344696879387, 0.2145850956439972, -0.09831131994724274, -0.21789665520191193, -0.08333683013916016, 0.07936320453882217, 0.10106749832630157, 0.06182991713285446, -0.021732350811362267, -0.0016442283522337675, -0.16811151802539825, -0.05288950726389885, -0.1022171601653099, -0.08327673375606537, -0.11628542840480804, -0.11630954593420029, 0.08672218024730682, -0.028342902660369873, 0.080956369638443, -0.08687847852706909, -0.014542488381266594, -0.04972759261727333, -0.16586509346961975, 0.0708530992269516, -0.08027024567127228, 0.05763176828622818, -0.1435086578130722, 0.19621510803699493, -0.01789693906903267, -0.1143677607178688, -0.15049295127391815, -0.00862482376396656, -0.14959174394607544, -0.04495536535978317, -0.18772904574871063, 0.11218790709972382, -0.18114785850048065, 0.2168724536895752, 0.13672687113285065, 0.14330072700977325, -0.20120689272880554, -0.018818700686097145, 0.023226307705044746, -0.32095032930374146, 0.09612946212291718, 0.005258659366518259, -0.22685551643371582, 0.055399857461452484, -0.21634075045585632, -0.05423116683959961, 0.06327167898416519, 0.30136215686798096, -0.13803865015506744, -0.03625902533531189, -0.03595852106809616, 0.24069556593894958, 0.18914814293384552, 0.11866562068462372, 0.11841003596782684, -0.08070392161607742, 0.023494891822338104, 0.1843753606081009, -0.06674133241176605, -0.20101074874401093, -0.19950944185256958, -0.10384482145309448, 0.04879213497042656, -0.009452896192669868, 0.035435751080513, -0.06790607422590256, -0.008569139055907726, 0.1247851699590683, 0.1113751158118248, -0.046365346759557724, 0.14368100464344025, -0.2341863363981247, -0.2651561200618744, 0.09083651006221771, -0.25543731451034546, -0.333882212638855, -0.11311008036136627, -0.08036629110574722, 0.09402523189783096, -0.12066421657800674, -0.09572654962539673, 0.5291741490364075, -0.01108586322516203, -0.04521416872739792, -0.12027301639318466, -0.02816827967762947, 0.028795789927244186, -0.038058098405599594, 0.09066222608089447, 0.11692778766155243, 0.07498723268508911, 0.13876348733901978, 0.05524178594350815, -0.312443345785141, -0.028948837891221046, -0.06445755064487457, 0.01168075017631054, -0.08748741447925568, -0.019154375419020653, -0.07943329960107803, -0.006655293051153421, -0.14634326100349426, 0.00010379920422565192, 0.3488069176673889, -0.008626933209598064, 0.18092294037342072, 0.110267773270607, 0.05795527249574661, 0.12964124977588654, 0.07496670633554459, -0.09042799472808838, -0.01588745415210724, 0.20163007080554962, 0.02141822688281536, 0.21249592304229736, -0.029495855793356895, 0.08801349252462387, -0.008230543695390224, -0.3453804552555084, -0.12306395918130875, 0.06213010475039482, 3.824807663477259e-06, 0.008020698092877865, -0.10241584479808807, 0.24768762290477753, -0.1965736299753189, -0.007474842481315136, 0.005955260246992111, 0.07559739798307419, 0.22719237208366394, -0.22873346507549286],
    "outputFields": ["theme","info"]
}
`)

	payloadRecycle := strings.NewReader(`
{
    "collectionName": "TAG",
      "limit": 108,
    "vector":[-0.031085163354873657, 0.09045658260583878, 0.1869550198316574, -0.02578706480562687, 0.008885159157216549, 0.04703490436077118, 0.09438106417655945, -0.08340902626514435, -0.10450944304466248, -0.06921117752790451, 0.20082183182239532, -0.05250466242432594, 0.0892811119556427, 0.07223042845726013, 0.007649490609765053, 0.08395618945360184, -0.16312730312347412, 0.1949353814125061, 0.0169638991355896, -0.08582893013954163, -0.14360864460468292, -0.05033918842673302, 0.04947182536125183, 0.08120013028383255, 0.13236075639724731, 0.07008460909128189, -0.14820511639118195, 0.14009509980678558, 0.20359858870506287, 0.006114933639764786, -0.06324506551027298, 0.28802192211151123, 0.057884376496076584, 0.12110698223114014, -0.04667268320918083, -0.08719071000814438, 0.030684782192111015, 0.11601952463388443, 0.00674124900251627, 0.26392948627471924, -0.08161208033561707, 0.10215751081705093, 0.0028618313372135162, 0.055554188787937164, -0.0759950578212738, 0.10215677320957184, 0.06604871153831482, -0.19659432768821716, 0.12219851464033127, -0.2951148450374603, 0.0015816709492355585, 0.3452235460281372, 0.051129795610904694, 0.007333660963922739, 0.02187228575348854, 0.06542789936065674, 0.05774126946926117, 0.041071102023124695, -0.06166969984769821, -0.16211016476154327, 0.022359270602464676, 0.05382155254483223, 0.1070343554019928, -0.13262629508972168, -0.17026278376579285, 0.11516952514648438, 0.10076408088207245, -0.2802993357181549, -0.03630157560110092, 0.0440070778131485, 0.08834546059370041, 0.020326226949691772, 0.08670374006032944, 0.10671871155500412, 0.02977784164249897, 0.07024586945772171, -0.024547521024942398, -0.10591091215610504, 0.08374777436256409, -0.07464957237243652, 0.10917750746011734, 0.19267182052135468, 0.09620087593793869, 0.044485945254564285, 0.00211763265542686, -0.03621764853596687, 0.07584003359079361, -0.25169840455055237, 0.07141061872243881, -0.021639462560415268, -9.650882020650897e-06, -0.05339941754937172, -0.03725406527519226, -0.1578998863697052, -0.16373611986637115, 0.219618558883667, 0.055901460349559784, -0.2000783085823059, -0.13042838871479034, -0.06873807311058044, 0.0809716060757637, -0.013366837985813618, 0.017271684482693672, -0.17163652181625366, -0.1681993007659912, -0.04997086524963379, -0.3814154863357544, -0.09231855720281601, -0.024417029693722725, -0.08588976413011551, 0.22062544524669647, 0.022962426766753197, -0.001146193128079176, 0.04416023567318916, -0.09189201146364212, 0.022006800398230553, 0.0023881334345787764, 0.15056385099887848, -0.1486271321773529, 0.06468195468187332, -0.2347225397825241, -0.011546080000698566, -0.05295870825648308, 0.2177041918039322, -0.1990727335214615, 0.15817001461982727, -0.0018891928484663367, -0.15299543738365173, 0.014408426359295845, -0.07044979184865952, -0.0651143416762352, 0.10660672932863235, 0.07397206872701645, 0.02086363360285759, -0.08041706681251526, 0.027481358498334885, 0.13037709891796112, 0.10887525230646133, -0.011395621113479137, 0.06325453519821167, 0.013072569854557514, 0.01256383117288351, 0.11323945969343185, -0.05137348175048828, -0.0234772190451622, 0.11149445176124573, 0.04309161752462387, -0.06729868054389954, 0.019969293847680092, 0.13199482858181, 0.07434185594320297, 0.2251332402229309, 0.10460764169692993, 0.19216887652873993, -0.1559751182794571, 0.018498923629522324, 0.06151793897151947, -0.15790513157844543, -0.027552776038646698, -0.16706503927707672, -0.06355676054954529, -0.2206815481185913, 0.050383370369672775, 0.19281946122646332, -0.0640321671962738, 0.030354993417859077, 0.1218804270029068, 0.035432737320661545, 0.003762969048693776, -0.32909807562828064, -0.10552254319190979, -0.12359222024679184, 0.05543890595436096, -0.03548232465982437, 0.010233361274003983, -0.013728789053857327, -0.03282763063907623, -0.0862518697977066, -0.08298230916261673, 0.02971804514527321, 0.22487854957580566, 0.05830927565693855, 0.02510341815650463, 0.21732529997825623, -0.01005365327000618, 0.09367184340953827, -0.10543864220380783, -0.000464298645965755, 0.15883779525756836, 0.04805080592632294, 0.11938030272722244, 0.1425812691450119, -0.0483677014708519, 0.03565642610192299, 0.0969720110297203, -0.08269726485013962, 0.055283401161432266, 0.0744362473487854, 0.08448091149330139, 0.055576927959918976, -0.027817871421575546, 0.05962040647864342, -0.016814976930618286, 0.05620613321661949, 0.0777217373251915, -0.11302319169044495, -0.030917324125766754, 0.13637584447860718, -0.037526413798332214, -0.09479251503944397, 0.04526492953300476, 0.026160715147852898, -0.26629552245140076, 0.17186756432056427, -0.07218269258737564, -0.03397615626454353, 0.09193367511034012, -0.210523784160614, -0.03876643627882004, 0.03685865178704262, -0.039126019924879074, -0.19015063345432281, 0.13504184782505035, -0.12815843522548676, 0.16666477918624878, -0.04314916580915451, 0.04259878769516945, -0.24057014286518097, -0.05258634686470032, 0.013395315036177635, -0.13388413190841675, -0.034090496599674225, 0.09526762366294861, 0.058386463671922684, 0.06023702397942543, 0.007232784293591976, -0.08903297781944275, 0.10673829168081284, 0.0022960896603763103, 0.11418402194976807, 0.04940733686089516, 0.22473931312561035, -0.10822777450084686, -0.06522421538829803, -0.01623402163386345, 0.16990973055362701, 0.09560668468475342, -0.018700115382671356, -0.09745960682630539, 0.0613885261118412, -0.01200755126774311, 0.09718002378940582, 0.09723568707704544, 0.08498862385749817, -0.3019605875015259, -0.17608705163002014, 0.05453215539455414, 0.0395854115486145, -0.16233129799365997, -0.01256832666695118, 0.030084703117609024, 0.10418747365474701, 0.023402992635965347, -0.08549805730581284, 0.03129824250936508, -0.09871992468833923, -0.055981703102588654, -0.10875050723552704, -0.07825581729412079, 0.07675262540578842, -0.06114807352423668, 0.07717994600534439, 0.08100183308124542, 0.2126215100288391, 0.03543129563331604, 0.05620430037379265, -0.18058234453201294, 0.11067528277635574, 0.13228648900985718, -0.0003741176042240113, 0.14948201179504395, 0.06216157227754593, -0.12709946930408478, -0.0997452363371849, -0.05612886697053909, 0.07026828080415726, 0.08826159685850143, 0.10826729983091354, -0.19012244045734406, -0.07127806544303894, -0.04846838861703873, 0.02957942709326744, 0.05652504414319992, -0.11228373646736145, -0.03556468337774277, -0.16647972166538239, -0.27883338928222656, -0.1525764763355255, -0.20952999591827393, 0.009945912286639214, 0.019893934950232506, 0.015036473982036114, -0.01563812978565693, -0.015516344457864761, 0.06162484362721443, -0.16184823215007782, -0.0006218597991392016, 0.2406907081604004, 0.055143993347883224, -0.03803851455450058, 0.26842832565307617, -0.03025919198989868, 0.012217562645673752, -0.013386365957558155, -0.10914292931556702, -0.05508847534656525, 0.008945589885115623, -0.021652474999427795, -0.07669959217309952, -0.11043506860733032, 0.09809890389442444, -0.09955340623855591, 0.1001962274312973, -0.1655580699443817, -0.15311817824840546, -0.1800042986869812, 0.12129244208335876, 0.020928101614117622, -0.008045431226491928, 0.007754438556730747, -0.02689552679657936, -0.16049718856811523, -0.09792511910200119, -0.016957111656665802, -0.18400543928146362, 0.060141708701848984, 0.15060776472091675, 0.14143308997154236, 0.03378094360232353, -0.12171895056962967, 0.014157661236822605, 0.25804147124290466, -0.061823487281799316, -0.005168119445443153, 0.2929745614528656, 0.07694950699806213, -0.09065684676170349, 0.022540122270584106, 0.12054857611656189, 0.14628122746944427, 0.14244650304317474, 0.057072713971138, 0.20873326063156128, 0.023198241367936134, -0.006067405920475721, 0.036773018538951874, 0.0986948311328888, 0.0442521907389164, -0.013525877147912979, 0.1055646613240242, -0.14826634526252747, 0.050864167511463165, 0.2178388237953186, 0.008952615782618523, -0.07628438621759415, 0.1902896761894226, -0.11262338608503342, 0.06528172641992569, 0.036389246582984924, 0.041683733463287354, -0.13602441549301147, -0.08783160895109177, -0.05681411549448967, 0.026925604790449142, -0.07963185012340546, 0.008773754350841045, 0.006966512184590101, -0.07695307582616806, -0.0013401450123637915, -0.03681182861328125, 0.07287914305925369, 0.06758828461170197, 0.077162966132164, -0.03809956833720207, 0.10589776188135147, -0.10081767290830612, -0.02005232498049736, 0.03947009891271591, -0.12937557697296143, -0.12418381124734879, -0.07160897552967072, 0.1594363898038864, -0.04749496653676033, -0.057636186480522156, 0.03430783376097679, -0.007680701091885567, 0.037920333445072174, -0.019712280482053757, -0.1556810736656189, -0.08210735768079758, 0.17364618182182312, -0.05268598347902298, -0.2507888078689575, -0.09111158549785614, 0.34599852561950684, 0.09977506846189499, 0.025368506088852882, 0.061069097369909286, 0.0031157906632870436, 0.08334484696388245, -0.15675479173660278, -0.12059847265481949, 0.05354810878634453, -0.23368123173713684, 0.16368524730205536, -0.0815209299325943, -0.05292866379022598, -0.13980548083782196, 0.047029342502355576, 0.08893409371376038, -0.019364725798368454, 0.13630713522434235, 0.19236059486865997, -0.02960619330406189, 0.040431275963783264, -0.013767898082733154, -0.07450835406780243, -0.005574429873377085, -0.2902688682079315, 0.006675010081380606, -0.18568548560142517, 0.11127939820289612, 0.06536667048931122, 0.03486393392086029, 0.034855205565690994, -0.23021548986434937, 0.1668056696653366, 0.04326549172401428, -0.03195609152317047, -0.18237850069999695, 0.13541431725025177, -0.14918439090251923, -0.060264136642217636, -0.134402334690094, 0.14520251750946045, 0.1455744355916977, 0.056955352425575256, 0.24426449835300446, 0.027034921571612358, 0.14696785807609558, -0.020438477396965027, 0.034451670944690704, -0.052224885672330856, 0.013922716490924358, 0.13525569438934326, 0.19620947539806366, 0.053648218512535095, 0.09321768581867218, -0.005929330829530954, -0.20324891805648804, 0.04767579585313797, -0.004808096680790186, -0.1779269427061081, -0.2649058997631073, -0.13076499104499817, -0.06759389489889145, 0.17628377676010132, 0.0935412347316742, 0.011590024456381798, -0.16625116765499115, 0.025462986901402473, -0.15056978166103363, 0.08461625874042511, -0.08845916390419006, -0.1035015881061554, 0.2371334731578827, 0.18639853596687317, 0.06688319146633148, -0.057318661361932755, -0.1932060420513153, -0.12890933454036713, 0.016036756336688995, -0.09140107780694962, 0.08272452652454376, 0.041335806250572205, -0.22590157389640808, -0.014395422302186489, 0.1568656712770462, -0.024353690445423126, -0.0009839484700933099, -0.016579801216721535, 0.06866403669118881, 0.16171668469905853, -0.007076971232891083, -0.006813911255449057, -0.048301585018634796, -0.12041681259870529, 0.10366757959127426, 0.04809902235865593, 0.2763371765613556, -0.1619468331336975, -0.0002767532132565975, 0.028972811996936798, -0.04603806138038635, 0.005833035334944725, -0.057083018124103546, 0.051882438361644745, 0.27417027950286865, 0.11081066727638245, 0.03310387581586838, 0.01772780902683735, -0.0017514073988422751, 0.11535290628671646, -0.02191762998700142, -0.14502643048763275, -0.06010304391384125, 0.07803834974765778, 0.034103620797395706, -0.07441310584545135, 0.008766282349824905, -0.05007842555642128, 0.03908941522240639, -0.1789717674255371, -0.10828232765197754, -0.11939067393541336, -0.013922687619924545, -0.1067216619849205, -0.10734650492668152, -0.013890407048165798, -0.2840542197227478, 0.12122900038957596, 0.11238447576761246, 0.11312498152256012, 0.02730223536491394, 0.0548076294362545, 0.10195562988519669, 0.0065591707825660706, 0.04170975089073181, -0.05808798596262932, -0.13397365808486938, 0.008501182310283184, -0.1717214435338974, 0.0739535540342331, -0.1129145622253418, -0.0957571417093277, 0.07339491695165634, -0.07236504554748535, -0.16637100279331207, -0.01156782079488039, -0.08124563843011856, -0.007400727830827236, 0.10744626820087433, 0.002032977994531393, -0.12359152734279633, -0.1389242708683014, -0.22909419238567352, 0.034635238349437714, -0.10700605064630508, 0.0056481510400772095, 0.054436568170785904, 0.098153255879879, 0.10445234179496765, 0.17054791748523712, 0.13352864980697632, 0.23578613996505737, -0.15718360245227814, -0.09490588307380676, -0.15823987126350403, -0.05396856367588043, -0.09361925721168518, 0.07692284137010574, 0.0019420890603214502, 0.18098761141300201, -0.058918409049510956, 0.0003165541565977037, -0.21113091707229614, -0.10818009078502655, 0.03960500285029411, 0.05124220624566078, -0.13163131475448608, 0.2187824845314026, -0.09380684792995453, -0.054213639348745346, -0.06201300397515297, -0.20713037252426147, 0.13280010223388672, 0.01869673654437065, 0.01519264467060566, 0.04971994832158089, -0.03608432039618492, 0.08277849107980728, 0.01770189218223095, -0.0218203105032444, -0.012612998485565186, -0.19473980367183685, -0.19583086669445038, -0.07211386412382126, 0.013392741791903973, -0.2956565320491791, -0.06843201816082001, -0.07548853754997253, 0.04722660407423973, -0.05704542621970177, -0.061954207718372345, 0.01319408044219017, -0.06610491126775742, -0.04153776913881302, -0.126299649477005, 0.1342630237340927, -0.33958569169044495, 0.21673451364040375, 0.12070968747138977, 0.06981463730335236, 0.13450278341770172, 0.2548435926437378, 0.13392701745033264, -0.37068623304367065, 0.06268749386072159, 0.04538595303893089, -0.040412288159132004, -0.034682825207710266, 0.06384819000959396, -0.028605440631508827, -0.04261593520641327, 0.016821740195155144, 0.05744181200861931, -0.02124972455203533, -0.13129830360412598, 0.08444373309612274, -0.012778457254171371, 0.17999325692653656, 0.05504762753844261, 0.07697202265262604, 0.044281672686338425, 0.12608177959918976, 0.05681915581226349, -0.17388367652893066, -0.14024507999420166, 0.17707093060016632, 0.24905960261821747, -0.00668626744300127, 0.0804545134305954, -0.110752172768116, -0.0475156232714653, -0.05972198769450188, 0.012286650016903877, 0.003984698560088873, -0.07170255482196808, -0.08778794854879379, -0.1323135644197464, -0.02898397669196129, 0.07646402716636658, 0.049130529165267944, -0.24941521883010864, -0.021862156689167023, 0.035700008273124695, 0.07124046236276627, -0.0013610931346192956, 0.0996476411819458, 0.038059160113334656, -0.14224964380264282, -0.010165435262024403, -0.053512927144765854, -0.30478641390800476, -0.15195387601852417, 0.10016073286533356, -0.18065345287322998, -0.09279164671897888, 0.008441735990345478, -0.18826983869075775, 0.05565274506807327, 0.08470192551612854, 0.026980692520737648, -0.004817398265004158, 0.12040676176548004, 0.012879028916358948, -0.029661821201443672, -0.05341215804219246, -0.21001528203487396, -0.13378795981407166, -0.175609290599823, -0.10797873884439468, -0.15925699472427368, 0.024961421266198158, 0.11652108281850815, 0.215189591050148, 0.06737563014030457, -0.002001740038394928, 0.05957869812846184, -0.027090590447187424, -0.04860479384660721, -0.0514485165476799, -0.20016345381736755, 0.2558886706829071, 0.12744581699371338, -0.22594213485717773, 0.0123162642121315, 0.010671093128621578, 0.09819809347391129, 0.09751597791910172, -0.1307365596294403, -0.05262589082121849, -0.052977126091718674, -0.08192011713981628, -0.084968201816082, 0.043929554522037506, 0.15371817350387573, 0.0055918144062161446, -0.09990572929382324, -0.2681547999382019, 0.0503704696893692, 0.07886525243520737, -0.09565044939517975, -0.19163651764392853, -0.0110953813418746, 0.05660969763994217, -0.020480655133724213, 0.010618643835186958, 0.27788782119750977, 0.1326293647289276, -0.032719895243644714, 0.07934120297431946, -0.07461681962013245, 0.09485377371311188, -0.07195201516151428, 0.03475122153759003, 0.03177812695503235, 0.12536205351352692, 0.08911293745040894, 0.06215380132198334, -0.024598587304353714, 0.035897672176361084, 0.20213733613491058, 0.02186501771211624, 0.1105080172419548, -0.16052481532096863, -0.12453147768974304, -0.1251378208398819, 0.06304710358381271, 0.040726177394390106, 0.049589138478040695, -0.14570221304893494, 0.09424994140863419, 0.32251980900764465, -0.0751110389828682, -0.060498908162117004, -0.17362762987613678, -0.08448290824890137, -0.2344209849834442, 0.06693117320537567, 0.26933753490448, 0.006804137025028467, -0.12234430760145187, 0.15902385115623474, 0.009060103446245193, 0.006782790180295706, 0.14347410202026367, -0.042742062360048294, 2.372626113356091e-06, 0.19539333879947662, 0.04559291899204254, 0.05460767820477486, 0.06748072057962418, -0.16974711418151855, -0.08385267108678818, 0.037704791873693466, 0.19647128880023956, -0.23490755259990692],
    "outputFields": ["theme","info"]
}`)
	vertorQueryResponse := VertorQueryResponse{}
	if strings.Contains(question.Question, "回收") {
		vertorQueryResponse = FetchVertorDB(payloadRecycle)
	} else {
		vertorQueryResponse = FetchVertorDB(payloadBus)

	}

	for _, datum := range vertorQueryResponse.Data {
		tagScores = append(tagScores, TagScore{TagName: datum.Info, Score: datum.Distance})
	}
	res := ResponseTagScores{Question: question.Question, Scores: tagScores, Threshold: rand.Intn(20) + 5}
	c.JSON(http.StatusOK, gin.H{"status": "success", "data": res})
	//c.JSON(http.StatusOK, gin.H{"status": "success", "data": tagScores})
}

func GetAllComponentText(c *gin.Context) {
	query := componentQuery{
		PageSize: 1000,
		PageNum:  1,
	}
	components, _, _, err := models.GetAllComponents(query.PageSize, query.PageNum, query.Sort, query.Order, query.FilterBy, query.FilterMode, query.FilterValue, query.SearchByIndex, query.SearchByName)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"status": "error", "message": err.Error()})
		return
	}

	componentTags := make(map[string]string)
	// Return the components
	for _, component := range components {
		queryType, queryString, err := models.GetComponentChartDataQuery(int(component.ID))
		if err != nil {
			//c.JSON(http.StatusInternalServerError, gin.H{"status": "error", "message": err.Error()})
			print(err)
			continue
		}

		timeFrom, timeTo := util.GetTime(c)
		tags := make(map[string]string)
		//components name, source, short_desc, long_desc, use_case
		tags["name"] = component.Name
		tags["source"] = component.Source
		tags["short_desc"] = component.ShortDesc
		tags["long_desc"] = component.LongDesc
		tags["use_case"] = component.UseCase
		//tags = append(tags, []string{component.Name, component.Source, component.ShortDesc, component.LongDesc, component.UseCase}...)

		if queryType == "two_d" {
			chartData, err := models.GetTwoDimensionalData(&queryString, timeFrom, timeTo)
			if err != nil {
				print(err)
				continue
			}

			for _, datum := range chartData {
				for _, data := range datum.Data {
					//tags = append(tags, data.Xaxis)
					tags[data.Xaxis] = data.Xaxis
				}
			}

		} else if queryType == "three_d" || queryType == "percent" {
			chartData, categories, err := models.GetThreeDimensionalData(&queryString, timeFrom, timeTo)
			if err != nil {
				print(err)
				continue
			}

			for _, datum := range chartData {
				//tags = append(tags, datum.Name)
				//tags = append(tags, datum.Icon)
				tags[datum.Name] = datum.Name
				tags[datum.Icon] = datum.Icon
			}

			//tags = append(tags, categories...)
			for _, category := range categories {
				tags[category] = category
			}

			//c.JSON(http.StatusOK, gin.H{"status": "success", "data": chartData, "categories": categories})
		} else if queryType == "time" {
			chartData, err := models.GetTimeSeriesData(&queryString, timeFrom, timeTo)
			if err != nil {
				print(err)
				continue
			}

			for _, datum := range chartData {
				//tags = append(tags, datum.Name)
				tags[datum.Name] = datum.Name
			}
			//c.JSON(http.StatusOK, gin.H{"status": "success", "data": chartData})
		} else if queryType == "map_legend" {
			chartData, err := models.GetMapLegendData(&queryString, timeFrom, timeTo)
			if err != nil {
				print(err)
				continue
			}

			for _, datum := range chartData {
				//tags = append(tags, datum.Name)
				tags[datum.Name] = datum.Name
			}
		}

		var tagList []string
		for key := range tags {
			value := tags[key]
			// check if key is number
			_, err := strconv.Atoi(key)
			if key != "" && err != nil {
				// if key 最後是 "區"，不加入tagList
				if !strings.HasSuffix(key, "區") {
					tagList = append(tagList, key)
				}
			}

			// check if value is number
			_, err = strconv.Atoi(value)
			if value != "" && err != nil {
				if !strings.HasSuffix(value, "區") {
					tagList = append(tagList, value)
				}
			}
		}

		tagList = append(tagList, component.Name)
		// join tagList with comma
		componentTags[component.Name] = strings.Join(tagList, ",")
	}

	c.JSON(http.StatusOK, gin.H{"status": "success", "data": componentTags})
}

func GetAllComponentTags(c *gin.Context) {
	query := componentQuery{
		PageSize: 1000,
		PageNum:  1,
	}
	components, _, _, err := models.GetAllComponents(query.PageSize, query.PageNum, query.Sort, query.Order, query.FilterBy, query.FilterMode, query.FilterValue, query.SearchByIndex, query.SearchByName)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"status": "error", "message": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"status": "success", "data": components})
}
